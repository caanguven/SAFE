<!-- templates/index.html -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Robot Control Interface</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f2f2f2;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .container {
            display: flex;
            flex-direction: row;
            justify-content: center;
            margin-top: 20px;
        }
        .controls, .camera {
            background-color: #ffffff;
            padding: 20px;
            margin: 10px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .controls {
            width: 300px;
        }
        .controls button {
            width: 80px;
            height: 50px;
            margin: 10px;
            font-size: 16px;
        }
        .mode-select {
            margin-top: 20px;
        }
        .status {
            margin-top: 20px;
            text-align: left;
        }
        .status p {
            margin: 5px 0;
        }
        .camera img {
            width: 640px;
            height: 480px;
            border: 2px solid #000000;
            border-radius: 4px;
        }
        .instructions {
            margin-top: 20px;
            font-size: 18px;
            text-align: center;
        }
    </style>
</head>
<body>
    <h1>Robot Control Interface</h1>

    <div class="instructions">
        <p>Use the arrow keys on your keyboard to control the robot:</p>
        <ul style="list-style: none;">
            <li><strong>Up Arrow:</strong> Forward</li>
            <li><strong>Down Arrow:</strong> Backward</li>
            <li><strong>Left Arrow:</strong> Turn Left</li>
            <li><strong>Right Arrow:</strong> Turn Right</li>
            <li><strong>Spacebar:</strong> Stop</li>
        </ul>
    </div>

    <div class="container">
        <!-- Motor Controls -->
        <div class="controls">
            <h2>Motor Controls</h2>
            <button onclick="sendDirection('forward')">Forward</button><br>
            <button onclick="sendDirection('left')">Left</button>
            <button onclick="sendDirection('stop')">Stop</button>
            <button onclick="sendDirection('right')">Right</button><br>
            <button onclick="sendDirection('backward')">Backward</button>

            <div class="mode-select">
                <label for="mode">Operating Mode:</label>
                <select id="mode" onchange="changeMode()">
                    <option value="normal" selected>Normal</option>
                    <option value="gallop">Gallop</option>
                </select>
            </div>

            <div class="status">
                <h3>Status</h3>
                <p id="mode-status">Operating Mode: Normal</p>
                <p id="direction-status">Direction: Stable</p>
                <p id="motor-status">M1: 0°, M2: 0°, M3: 0°, M4: 0°</p>
                <p id="phase-status">Phase Differences - M1-M3: 0°, M2-M4: 0°</p>
            </div>
        </div>

        <!-- Camera Feed -->
        <div class="camera">
            <h2>Camera Feed</h2>
            <img src="{{ url_for('video_feed') }}" alt="Camera Feed">
        </div>
    </div>

    <script>
        // Map keyboard keys to directions
        const keyDirectionMap = {
            'ArrowUp': 'forward',
            'ArrowDown': 'backward',
            'ArrowLeft': 'left',
            'ArrowRight': 'right',
            ' ': 'stable'  // Spacebar
        };

        // Track currently pressed keys to handle multiple key presses
        const pressedKeys = new Set();

        // Listen for keydown events
        document.addEventListener('keydown', function(event) {
            const direction = keyDirectionMap[event.key];
            if (direction && !pressedKeys.has(event.key)) {
                event.preventDefault(); // Prevent default scrolling behavior
                pressedKeys.add(event.key);
                sendDirection(direction);
            }
        });

        // Listen for keyup events
        document.addEventListener('keyup', function(event) {
            const direction = keyDirectionMap[event.key];
            if (direction) {
                event.preventDefault();
                pressedKeys.delete(event.key);
                sendDirection('stable');
            }
        });

        // Optional: Handle window blur (when the user switches tabs or windows)
        window.addEventListener('blur', function() {
            if (pressedKeys.size > 0) {
                pressedKeys.clear();
                sendDirection('stable');
            }
        });

        function sendDirection(direction) {
            fetch('/control', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 'direction': direction }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById('direction-status').innerText = 'Direction: ' + capitalizeFirstLetter(data.direction);
                } else {
                    console.error('Error:', data.message);
                }
            })
            .catch((error) => {
                console.error('Error:', error);
            });
        }

        function changeMode() {
            var mode = document.getElementById('mode').value;
            fetch('/mode', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 'mode': mode }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById('mode-status').innerText = 'Operating Mode: ' + capitalizeFirstLetter(data.mode);
                } else {
                    console.error('Error:', data.message);
                }
            })
            .catch((error) => {
                console.error('Error:', error);
            });
        }

        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }

        function updateStatus() {
            fetch('/status')
            .then(response => response.json())
            .then(data => {
                if (data.status !== 'error') {
                    document.getElementById('mode-status').innerText = 'Operating Mode: ' + capitalizeFirstLetter(data.mode);
                    document.getElementById('direction-status').innerText = 'Direction: ' + capitalizeFirstLetter(data.direction);
                    document.getElementById('motor-status').innerText = 
                        'M1: ' + data.motors.M1.toFixed(1) + '°, ' +
                        'M2: ' + data.motors.M2.toFixed(1) + '°, ' +
                        'M3: ' + data.motors.M3.toFixed(1) + '°, ' +
                        'M4: ' + data.motors.M4.toFixed(1) + '°';
                    document.getElementById('phase-status').innerText = 
                        'Phase Differences - M1-M3: ' + data.phase_diff['M1-M3'].toFixed(1) + '°, ' +
                        'M2-M4: ' + data.phase_diff['M2-M4'].toFixed(1) + '°';
                } else {
                    console.error('Error:', data.message);
                }
            })
            .catch((error) => {
                console.error('Error:', error);
            });
        }

        // Update status every second
        setInterval(updateStatus, 1000);
    </script>
</body>
</html>
