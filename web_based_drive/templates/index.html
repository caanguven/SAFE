<!-- templates/index.html -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Web Based Control</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Tufts University Blue Background */
        body {
            background-color: #004687;
            color: #ffffff;
            height: 100vh;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        /* Center Content Vertically and Horizontally */
        .content-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 20px;
        }
        /* Header Styling */
        .header {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 20px;
            animation: fadeInDown 1s ease-out;
        }
        /* Main Content Styling */
        .main-content {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            width: 100%;
        }
        /* Camera Feed Styling */
        .camera-feed {
            border: 5px solid #ffffff;
            border-radius: 10px;
            max-width: 600px;
            width: 100%;
            height: auto;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            transition: transform 0.3s ease;
        }
        .camera-feed:hover {
            transform: scale(1.02);
        }
        /* IMU Visualization Styling */
        .imu-visualization {
            border: 5px solid #ffffff;
            border-radius: 10px;
            max-width: 600px;
            width: 100%;
            height: 400px;
            background-color: #222;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            position: relative;
        }
        /* Status Panel Styling */
        .status-panel {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            width: 80%;
            max-width: 600px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            animation: fadeInUp 1s ease-out;
        }
        .status-panel h3 {
            margin-bottom: 15px;
            color: #FFD700; /* Gold color for headings */
            font-size: 1.8rem;
        }
        .status-panel p {
            font-size: 1.2rem;
            margin: 5px 0;
        }
        /* Gait Toggle Button */
        .gait-toggle {
            margin-top: 20px;
        }
        .gait-toggle button {
            width: 200px;
            height: 50px;
            font-size: 1.1rem;
            transition: background-color 0.3s, transform 0.3s;
        }
        .gait-toggle button:hover {
            transform: scale(1.05);
        }
        /* Animations */
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div class="content-container">
        <!-- Header -->
        <div class="header">
            Web Based Control
        </div>

        <!-- Main Content: Camera and IMU Visualization -->
        <div class="main-content">
            <!-- Camera Feed -->
            <div>
                <img src="{{ url_for('video_feed') }}" alt="Camera Feed" class="camera-feed img-fluid">
            </div>

            <!-- IMU Visualization -->
            <div class="imu-visualization">
                <h3 style="position:absolute; top:10px; left:50%; transform:translateX(-50%); color:#FFD700; z-index:1;">IMU Data Visualization</h3>
                <div id="cube-container" style="width:100%; height:100%;"></div>
                <div id="imu-data" style="position:absolute; bottom:10px; left:50%; transform:translateX(-50%); color:#FFD700; z-index:1;">
                    <p>Roll: <span id="roll">0</span>°</p>
                    <p>Pitch: <span id="pitch">0</span>°</p>
                    <p>Yaw: <span id="yaw">0</span>°</p>
                </div>
            </div>
        </div>

        <!-- Gait Toggle Button -->
        <div class="gait-toggle">
            <button class="btn btn-custom" id="gaitButton" onclick="toggleGait()">Switch to Gallop</button>
        </div>

        <!-- Status Panel -->
        <div class="status-panel text-white">
            <h3>Status</h3>
            <p id="mode-status">Operating Mode: Trot</p>
            <p id="direction-status">Direction: Stable</p>
            <p id="motor-status">M1: 0°, M2: 0°, M3: 0°, M4: 0°</p>
            <p id="phase-status">Phase Differences - M1-M3: 0°, M2-M4: 0°</p>
        </div>
    </div>

    <!-- Bootstrap JS (Optional: for interactive components) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Three.js and STLLoader -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.126.1/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three/examples/js/loaders/STLLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three/examples/js/controls/OrbitControls.js"></script>

    <!-- JavaScript for Keyboard Controls, Gait Toggle, Status Updates, and IMU Visualization -->
    <script>
        // Map keyboard keys to directions
        const keyDirectionMap = {
            'ArrowUp': 'forward',
            'ArrowDown': 'backward',
            'ArrowLeft': 'left',
            'ArrowRight': 'right',
            ' ': 'stable'  // Spacebar
        };

        // Track currently pressed keys to handle multiple key presses
        const pressedKeys = new Set();

        // Listen for keydown events
        document.addEventListener('keydown', function(event) {
            const direction = keyDirectionMap[event.key];
            if (direction && !pressedKeys.has(event.key)) {
                event.preventDefault(); // Prevent default scrolling behavior
                pressedKeys.add(event.key);
                sendDirection(direction);
            }
        });

        // Listen for keyup events
        document.addEventListener('keyup', function(event) {
            const direction = keyDirectionMap[event.key];
            if (direction) {
                event.preventDefault();
                pressedKeys.delete(event.key);
                sendDirection('stable');
            }
        });

        // Optional: Handle window blur (when the user switches tabs or windows)
        window.addEventListener('blur', function() {
            if (pressedKeys.size > 0) {
                pressedKeys.clear();
                sendDirection('stable');
            }
        });

        function sendDirection(direction) {
            fetch('/control', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 'direction': direction }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById('direction-status').innerText = 'Direction: ' + capitalizeFirstLetter(data.direction);
                } else {
                    console.error('Error:', data.message);
                }
            })
            .catch((error) => {
                console.error('Error:', error);
            });
        }

        // Gait Toggle Function
        let currentGait = 'trot'; // Default gait

        function toggleGait() {
            const gaitButton = document.getElementById('gaitButton');
            if (currentGait === 'trot') {
                // Switch to gallop
                fetch('/mode', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 'mode': 'gallop' }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        currentGait = 'gallop';
                        gaitButton.innerText = 'Switch to Trot';
                        document.getElementById('mode-status').innerText = 'Operating Mode: Gallop';
                    } else {
                        console.error('Error:', data.message);
                    }
                })
                .catch((error) => {
                    console.error('Error:', error);
                });
            } else {
                // Switch to trot
                fetch('/mode', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 'mode': 'normal' }), // Assuming 'normal' corresponds to 'trot'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        currentGait = 'trot';
                        gaitButton.innerText = 'Switch to Gallop';
                        document.getElementById('mode-status').innerText = 'Operating Mode: Trot';
                    } else {
                        console.error('Error:', data.message);
                    }
                })
                .catch((error) => {
                    console.error('Error:', error);
                });
            }
        }

        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }

        function updateStatus() {
            fetch('/status')
            .then(response => response.json())
            .then(data => {
                if (data.status !== 'error') {
                    document.getElementById('mode-status').innerText = 'Operating Mode: ' + capitalizeFirstLetter(data.mode === 'normal' ? 'Trot' : data.mode);
                    document.getElementById('direction-status').innerText = 'Direction: ' + capitalizeFirstLetter(data.direction);
                    document.getElementById('motor-status').innerText = 
                        'M1: ' + data.motors.M1.toFixed(1) + '°, ' +
                        'M2: ' + data.motors.M2.toFixed(1) + '°, ' +
                        'M3: ' + data.motors.M3.toFixed(1) + '°, ' +
                        'M4: ' + data.motors.M4.toFixed(1) + '°';
                    document.getElementById('phase-status').innerText = 
                        'Phase Differences - M1-M3: ' + data.phase_diff['M1-M3'].toFixed(1) + '°, ' +
                        'M2-M4: ' + data.phase_diff['M2-M4'].toFixed(1) + '°';
                } else {
                    console.error('Error:', data.message);
                }
            })
            .catch((error) => {
                console.error('Error:', error);
            });
        }

        // Update status every second
        setInterval(updateStatus, 1000);

        // +++++++++++++++++++++++++++++++++++++++++++ IMU Visualization with Three.js +++++++++++++++++++++++++++++++++++++++++++

        let scene, camera3D, renderer, model, controls;

        function initThreeJS() {
            const container = document.getElementById('cube-container');

            // Scene 
            scene = new THREE.Scene();

            // Camera
            camera3D = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera3D.position.set(0, 0, 5);

            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            container.appendChild(renderer.domElement);

            // STL Loader
            const loader = new THREE.STLLoader();
            loader.load('/static/model.stl', function (geometry) {
                geometry.center();
                console.log('STL Loaded');
                const material = new THREE.MeshPhongMaterial({ color: 0x555555, specular: 0x111111, shininess: 200 });
                model = new THREE.Mesh(geometry, material);
                model.scale.set(0.02, 0.02, 0.02); // Adjust scale as needed
                model.castShadow = true;
                model.receiveShadow = true;

                scene.add(model);
            });

            // Lights
            const ambientLight = new THREE.AmbientLight(0x404040); 
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1); 
            directionalLight.position.set(1, 1, 1).normalize();
            scene.add(directionalLight);

            // Controls
            controls = new THREE.OrbitControls(camera3D, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;

            animate();
        }

        function animate() {
            requestAnimationFrame(animate);
            if (controls) controls.update();
            renderer.render(scene, camera3D);
        }

        function setModelRotation(roll, pitch, yaw) {
            if (model) {
                // Convert degrees to radians and apply rotation
                model.rotation.x = -pitch * Math.PI / 180;
                model.rotation.y = yaw * Math.PI / 180;
                model.rotation.z = -roll * Math.PI / 180;
            }
        }

        function fetchIMUData() {
            fetch('/imu_data')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('roll').textContent = data.roll.toFixed(2);
                    document.getElementById('pitch').textContent = data.pitch.toFixed(2);
                    document.getElementById('yaw').textContent = data.yaw.toFixed(2);
                    setModelRotation(data.roll, data.pitch, data.yaw);
                })
                .catch(error => console.error('Error fetching IMU data:', error));
        }

        // Initialize Three.js
        initThreeJS();

        // Fetch the IMU data every 100 milliseconds
        setInterval(fetchIMUData, 100);
    </script>
</body>
</html>
